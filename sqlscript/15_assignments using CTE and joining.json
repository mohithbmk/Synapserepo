{
	"name": "15_assignments using CTE and joining",
	"properties": {
		"folder": {
			"name": "nyc_taxi/Discovery"
		},
		"content": {
			"query": "USE nyc_taxi_discovery;\n/*\nidentify the percentage of cash and credit card trips y borough\nexample data as below\n-------------------------------------------------------------------------------------------------------------------\nborough\t\t\ttotal_trips\t\tcash_trips\t\tcard_trips\t\tcash_trips_percentage\t\tcard_trips_percentage\n--------------------------------------------------------------------------------------------------------------------\nBronx\t\t\t2019\t\t\t751\t\t\t\t1268\t\t\t37.20\t\t\t\t\t\t62.80\nBrooklyn\t\t6435\t\t\t2192\t\t\t4243\t\t\t34.06\t\t\t\t\t\t65.94\n---------------------------------------------------------------------------------------------------------------------\n*/\n\nWITH v_payment_type AS\n(\n    \nSELECT CAST(JSON_VALUE(jsondoc,'$.payment_type') as smallint) payment_type,\n        CAST(JSON_VALUE(jsondoc,'$.payment_type_desc[0].value') as VARCHAR(15)) payment_type_desc\n    FROM OPENROWSET(\n        BULK 'payment_type_array.json',\n        DATA_SOURCE = 'nyc_taxi_data_raw',\n        FORMAT ='CSV',\n        PARSER_VERSION ='1.0',\n        FIELDTERMINATOR = '0x0b',\n        FIELDQUOTE = '0x0b',\n        ROWTERMINATOR = '0x0a'\n    )\n    with(\n        jsondoc NVARCHAR(MAX)\n    ) \n    AS paymenttype\n),\nv_taxi_zone AS\n(\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'taxi_zone.csv',\n        DATA_SOURCE = 'nyc_taxi_data_raw',\n        FORMAT = 'CSV',\n        PARSER_VERSION = '2.0',\n        HEADER_ROW = TRUE\n    )\n     WITH\n    (\n        location_id SMALLINT 1 ,\n        borough VARCHAR(15) 2,\n        zone VARCHAR(50) 3,\n        service_zone VARCHAR(15) 4\n    )\n    AS taxi_zone\n),\n\nv_trip_data AS \n(\n    SELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/**',\n        DATA_SOURCE = 'nyc_taxi_data_raw',\n        FORMAT = 'PARQUET'\n    ) AS trip_data\n)\n\n\nSELECT\n    v_taxi_zone.borough,\n    COUNT(1) as total_trips,\n    SUM(case when v_payment_type.payment_type_desc = 'Cash' THEN 1 ELSE 0 END) as cash_trips,\n    SUM(case when v_payment_type.payment_type_desc = 'Credit card' THEN 1 ELSE 0 END) as card_trips,\n    CAST((SUM(case when v_payment_type.payment_type_desc = 'Cash' THEN 1 ELSE 0 END) / CAST(count(1) AS DECIMAL)) * 100 as DECIMAL(5,2)) as cash_trips_percentage,\n    CAST((SUM(case when v_payment_type.payment_type_desc = 'Credit card' THEN 1 ELSE 0 END) / CAST(count(1) AS DECIMAL)) * 100 as DECIMAL(5,2)) as card_trips_percentage\nFrom v_trip_data\nLEFT JOIN v_payment_type ON(v_trip_data.payment_type = v_payment_type.payment_type)\nLEFT join v_taxi_zone ON (v_trip_data.PULocationID = v_taxi_zone.location_id)\nwhere v_payment_type.payment_type_desc IN('Cash','Credit card')\nGroup by v_taxi_zone.borough\norder by v_taxi_zone.borough\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "nyc_taxi_discovery",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}